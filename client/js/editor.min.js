(function(a,b){"use strict";function m(){f.calcOffset(),f.renderAll()}function n(){isEmpty(f)&&(f=new fabric.Canvas("case-editor",k),f.setBackgroundColor("#000000"))}function o(a,b,c){var g,h,d=document.createElement("img"),e=d.width,f=d.height;return d.src=a,c>e&&b>f?1:(g=c/e,h=b/f,Math.min(g,h))}function p(){var a=c[d].width/2,b=c[d].height/2;return{left:a,top:b}}function q(a){f.add(a),f.setActiveObject(a)}function r(a){var b=null,c=50,d={left:fabric.util.getRandomInt(c,270-c),top:fabric.util.getRandomInt(c,650-c),angle:fabric.util.getRandomInt(-20,40),padding:10,cornersize:10};fabric.loadSVGFromURL(a,function(a,c){b=fabric.util.groupSVGElements(a,c),b.set(d),q(b),m()})}function s(a){var b,e;fabric.Image.fromURL(a,function(f){b=o(a,c[d].width,c[d].height),e=p(),q(f.scale(b).set(e)),m()})}function t(a){function e(a){b=new FileReader,b.onload=function(){return function(a){s(a.target.result,f)}}(a),b.readAsDataURL(a)}var b=null,c=0,d=null;for(c=0;a.length>c;c++)d=a[c],d.type.match("image.*")&&e(d)}function u(a,b){var c;c=p(),b.left=c.left,b.top=c.top,a=new fabric.Text(a,b),q(a),m()}function v(){var a=null,c={},g=document.getElementById("putCanvas");null===g&&(a=JSON.stringify(f),c.canvas=a,c.phone=d,c.case=e,b.sessionStorage.design=JSON.stringify(c))}function w(a){return l=!1,g.removeClass("case-editor"),v(),h.off("StartEditor"),"beforeunload"===a.type?"Weet u zeker dat u de pagina wilt verlaten zonder op te slaan?":(f=null,void 0)}function x(){function b(a,b){try{j[a](b)}catch(c){j.handleDefaultObject(b)}}function c(c){var d=c.target,e=d.type,f="handle"+capitaliseFirstLetter(e)+"Object";a("#object-controls").show(),b(f,d)}function d(){a("#object-controls").hide()}f.on("object:selected",c),f.on("group:selected",c),f.on("selection:cleared",d)}function y(a,b){d=a,e=b||1,f.setWidth(c[a].width),f.setHeight(c[a].height),f.renderAll()}function z(b,c){a(b).animate({left:c},500,function(){})}function A(a){a&&a.hasOwnProperty("canvas")&&!l&&(f.loadFromJSON(a.canvas),m(),l=!0)}function B(a,b){var c=a;isEmpty(b)&&(b=!1),b||(c={source:a,repeat:"repeat"}),f.setBackgroundColor(c,function(){m()})}function E(){var b=f.getActiveObject(),c=f.getActiveGroup();c?(c.forEachObject(function(a){f.remove(a)}),f.discardActiveGroup()):b&&f.remove(f.getActiveObject()),m()}function F(a,b,c){function e(a,b,c,d){a[b]=a[b]===c?"normal":c,d.toggleClass("active")}var d=f.getActiveObject();isEmpty(d)||"text"!==d.type||(e(d,a,b,c),m())}function G(b){var c=a(b.target),d=c.data("type"),e=c.data("setting")||c.val(),f=c.attr("type");("number"===f||"range"===f)&&(e=parseInt(e,10)),F(d,e,c)}function H(b){var c=f.getActiveObject(),d=f.getActiveGroup(),e=c||d,g=a(b.target).val(),h=parseInt(g,10);e&&(e.setOpacity(h/100),m())}function I(){confirm("Weet u het zeker?")&&(f.setBackgroundColor("#000000"),f.clear(),m())}function J(b){var c=f.getActiveObject(),d=f.getActiveGroup(),e=a(b.target).data("fn"),g=c||d;g&&(g[e](),m())}function K(b){var c=f.getActiveObject(),d=f.getActiveGroup(),e=c||d,g=a(b.target).val();e&&(e.setFill(g),m())}function L(a,b,c,d){var e=parseInt(a[c],10);"-"===d&&(e-=b?10:1),"+"===d&&(e+=b?10:1),a[c]=e}var c={4:{width:270,height:532},5:{width:270,height:569}},d=4,e=0,f=null,g=a(document.body),h=a(document),i=a(b),j={handleTextObject:function(b){a("#text").find("button").attr("disabled",!1),a("#text textarea").val(b.getText())},handleDefaultObject:function(){}},k={centerTransform:!0,controlsAboveOverlay:!0,selectionBorderColor:"black",selectionColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:2},l=!1;i.on("beforeunload",w),i.on("hashchange",w),h.ready(function(){g.addClass("case-editor")}),hasFileUploadSupport()?(a("#upload").show(),a("#upload").on("change",function(a){return t(a.target.files,f),stopEvent(a)})):a("#upload").hide(),h.on("StartEditor",function(a,b){g.addClass("case-editor"),n(),y(b.phone,b.case),x(),A(b.design)}),a(".sel-bg").on("click",".icon-caret-right",function(b){return z(".sel-bg .sliderow","-=250"),a(".sel-bg").find(".icon-caret-left").css("visibility","visible"),stopEvent(b)}),a(".icon-caret-left").css("visibility","hidden"),a(".sel-bg").on("click",".icon-caret-left",function(b){var c=a(".sel-bg .sliderow"),d=a(b.target),e=parseInt(c.position().left,10);return 0>e+250?d.css("visibility","visible"):d.css("visibility","hidden"),0>e?z(".sel-bg .sliderow","+=250"):d.css("visibility","hidden"),stopEvent(b)}),a(".sel-object").on("click",".icon-caret-right",function(b){return z(".sel-object .sliderow","-=150"),a(".sel-object").find(".icon-caret-left").css("visibility","visible"),stopEvent(b)}),a(".sel-object").on("click",".icon-caret-left",function(b){var c=a(".sel-object .sliderow"),d=a(b.target),e=parseInt(c.position().left,10);return 0>e+150?d.css("visibility","visible"):d.css("visibility","hidden"),0>e?z(".sel-object .sliderow","+=150"):d.css("visibility","hidden"),stopEvent(b)}),a("#add-text").on("click",function(b){var c={originX:"left",lineHeight:1,fontFamily:a("#set-font").val().toLowerCase(),fontSize:+a("#set-font-size").val(),fill:a("#set-font-color").val(),fontWeight:"normal"};return u(a("#set-text").val(),c),a("#set-text").val(""),stopEvent(b)}),a(".sel-bg").find(".background-slider").on("click","img",function(b){B(a(b.target).data("url"))}),a(".sel-object").find(".background-slider").on("click","img",function(b){r(a(b.target).data("url"))}),a(".form-horizontal").find("button#postCanvas").attr("disabled",!0),a("input#name").on({keyup:function(b){var c=a(".form-horizontal").find("button"),d=a(b.target).val();!isEmpty(d)&&d.length>3?c.attr("disabled",!1):c.attr("disabled",!0)},focus:function(){f.deactivateAll().renderAll()}}),a(".form-horizontal").on("click","button",function(c){function j(){var c=f.toDataURL("png"),g=JSON.stringify(f),h=JSON.parse(b.sessionStorage.loggedInUser);return{name:a("input#name").val(),preview:c,canvas:g,phone:d,"case":e,shared:!0,user:h._id}}function k(c,d,e){function f(a){isEmpty(a.error)?(b.location.hash="/product/"+a.result._id,Application.notify("ok","Uw case is succesvol opgelsagen.")):Application.notify("error",a.error)}a.ajax({url:"http://autobay.tezzt.nl:43083/"+e,type:d,data:c,success:f})}var g=a(c.target),h=null,i='<img alt="" src="http://94.210.234.160/_design_your_own/img/loading.gif">';if(g.attr("disabled",!0),g.html(i+" Bezig met opslaan."),a(".ontwerpen").addClass("transparent"),b.sessionStorage.loggedInUser)try{f.deactivateAll().renderAll(),h=j(),"postCanvas"===a(c.target).attr("id")?k(h,"POST","casedesigns"):"putCanvas"===a(c.target).attr("id")&&k(h,"PUT","casedesign/"+g.data("id"))}catch(l){Application.notify("error","Je browser ondersteund geen export van de canvas, helaas!"+l)}else Application.notify("error","Je moet ingelogd zijn om een ontwerp te kunnen opslaan.");return stopEvent(c)}),a(".sel-text").on("click","a",G),a(".sel-text").on("change","select, input",G),a(".sel-text").on("keydown","input, textarea",G),a("#color").on("change",K),a("#opacity").on("change",H),a("#del-object").on("click",E),a("#del-all").on("click",I),a(".index-group").on("click","a",J),a("#background-color").on("change",function(b){var c=a(b.target).val();B(c,!0)}),h.on("keydown",function(b){var c=b.which,d=String.fromCharCode(c),e=f.getActiveObject()||f.getActiveGroup(),g="",h=!0,i=b.target.tagName.toLowerCase();return e&&"input"!==i&&"textarea"!==i?(46===c?f.remove(e):27===c?(f.deactivateAll(),m(),e.originalText&&(g=e.originalText,h=!1)):38===c?L(e,b.shiftKey,"top","-"):40===c?L(e,b.shiftKey,"top","+"):37===c?L(e,b.shiftKey,"left","-"):39===c?L(e,b.shiftKey,"left","+"):"text"===e.type&&(e.originalText||(e.originalText=e.text),16===c?g=e.text:8===c?(b.preventDefault(),g=e.text.substr(0,e.text.length-1)):13===c?(g=e.text+"\n",h=!0):isAllowedChar(c)&&(e.text===e.originalText&&(e.text=""),d.match(/[A-Z]/)&&!b.shiftKey&&(d=d.toLowerCase()),g=e.text+d),a("#set-text").val(g),e.set({text:g}),h||(this.target.originalText=null)),m(),stopEvent(b)):void 0})})(jQuery,this);